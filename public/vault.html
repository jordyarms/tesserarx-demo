<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Vault — Tesserarx</title>
    <meta name="description" content="View and manage your tarot deck passes. Your personal content library.">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: '#08090e',
                        surface: '#0f1117',
                        border: '#181b24',
                        accent: '#00c9ff',
                        accent2: '#8b7aff',
                        muted: '#9ca3af'
                    }
                }
            }
        }
    </script>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="dist/tesserarx-polkadot.umd.cjs"></script>
    <script src="content-loader.js"></script>
</head>
<body>
    <div class="grid-overlay"></div>

    <div class="relative z-10">
        <div class="max-w-7xl mx-auto px-6 md:px-12 py-16 md:py-24">

            <!-- Header -->
            <header class="mb-24 fade-in" style="animation-delay: 0s">
                <div class="text-center">

                    <h1 class="heading text-5xl mb-4">
                        Your Collection
                    </h1>

                    <!-- Decorative line -->
                    <div class="divider mt-12"></div>
                </div>
            </header>

            <!-- Connection -->
            <div class="glass rounded-3xl p-10 mb-12 hover-lift fade-in relative" style="animation-delay: 0.1s">
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>

                <div class="text-center relative z-10">
                    <button
                        id="connectButton"
                        onclick="connectWallet()"
                        class="btn text-text px-12 py-4 rounded-xl relative"
                    >
                        <span class="relative z-10">Initialize Connection</span>
                    </button>
                    <div id="walletInfo" class="mt-6 hidden"></div>
                </div>
            </div>

            <!-- Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-16 fade-in" style="animation-delay: 0.2s">
                <div class="glass rounded-2xl p-6 hover-lift text-center">
                    <div class="mono text-micro text-muted uppercase mb-3">Total Decks</div>
                    <div class="mono text-4xl text-accent font-light" id="totalDecks">—</div>
                </div>
                <div class="glass rounded-2xl p-6 hover-lift text-center">
                    <div class="mono text-micro text-muted uppercase mb-3">Owned</div>
                    <div class="mono text-4xl text-accent2 font-light" id="ownedDecks">—</div>
                </div>
                <div class="glass rounded-2xl p-6 hover-lift text-center">
                    <div class="mono text-micro text-muted uppercase mb-3">Free Access</div>
                    <div class="mono text-4xl text-green-400 font-light" id="freeDecks">—</div>
                </div>
                <div class="glass rounded-2xl p-6 hover-lift text-center">
                    <div class="mono text-micro text-muted uppercase mb-3">Network</div>
                    <div class="mono text-2xl text-text/80 font-light">Moonbase</div>
                </div>
            </div>

            <!-- Deck Grid -->
            <div id="deckGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-20">
                    <div class="status mx-auto mb-4"></div>
                    <div class="mono text-caption text-muted">Loading vault data...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Contract ABI - V2.1 (CONTRACT_ADDRESS and MOONBASE_ALPHA come from wallet-persistence.js)
        const CONTRACT_ABI = [
            "function balanceOf(address account, uint256 id) view returns (uint256)",
            "function uri(uint256 tokenId) view returns (string)",
            "function getContentInfo(uint256 contentId) view returns (address creator, string name, bool isFree, uint256 price, uint256 referralBasisPoints, uint256 maxSupply, uint256 currentSupply)",
            "function getActiveVersion(uint256 contentId) view returns (tuple(string payloadURI, string specificationURI, string manifestURI, uint256 timestamp, string reason, address updatedBy))",
            "function claim(uint256 contentId) external",
            "function contentCreators(uint256 contentId) view returns (address)"
        ];

        let provider, signer, contract, userAddress;
        let ownedDecks = [];

        async function connectWallet() {
            try {
                // Use Polkadot wallet manager
                const connected = await walletManager.connect();

                if (!connected) {
                    return;
                }

                // Get provider and contract from wallet manager
                provider = await walletManager.getWeb3Provider();
                contract = await walletManager.getContract(CONTRACT_ABI);
                userAddress = walletManager.getEvmAddress();

                document.getElementById('connectButton').style.display = 'none';
                document.getElementById('walletInfo').classList.remove('hidden');

                const accountName = walletManager.getAccount()?.meta?.name || 'Account';
                document.getElementById('walletInfo').innerHTML = `
                    <div class="inline-flex items-center gap-2 mono text-caption text-accent">
                        <div class="status"></div>
                        <span>Connected: ${accountName} (${userAddress.slice(0, 6)}...${userAddress.slice(-4)})</span>
                    </div>
                `;

                await loadLibrary();

            } catch (error) {
                console.error('Connection error:', error);
                alert('Connection failed: ' + error.message);
            }
        }

        async function loadLibrary() {
            const grid = document.getElementById('deckGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-20"><div class="status mx-auto mb-4"></div><div class="mono text-caption text-muted">Loading your collection...</div></div>';

            try {
                // Load only owned decks using ContentLoader
                ownedDecks = await ContentLoader.loadOwnedDecks(contract, userAddress);

                grid.innerHTML = '';

                if (ownedDecks.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-20">
                            <div class="mono text-2xl text-muted mb-4">No decks owned yet</div>
                            <div class="mono text-caption text-muted/70 mb-8">Visit the Market to claim free decks or purchase passes</div>
                            <a href="deck-library.html" class="btn text-text px-8 py-4 rounded-xl inline-block">
                                <span class="relative z-10">Browse Market</span>
                            </a>
                        </div>
                    `;
                    document.getElementById('totalDecks').textContent = '0';
                    document.getElementById('ownedDecks').textContent = '0';
                    document.getElementById('freeDecks').textContent = '0';
                    return;
                }

                // Count free decks among owned
                let freeCount = ownedDecks.filter(d => d.free).length;

                // Display only owned decks
                for (const [index, deck] of ownedDecks.entries()) {
                    const card = createCard(deck, true); // hasPass is always true in vault
                    card.style.animationDelay = `${0.3 + index * 0.08}s`;
                    grid.appendChild(card);
                }

                // Update metrics - all decks shown are owned
                document.getElementById('totalDecks').textContent = ownedDecks.length;
                document.getElementById('ownedDecks').textContent = ownedDecks.length;
                document.getElementById('freeDecks').textContent = freeCount;

            } catch (error) {
                console.error('Failed to load collection:', error);
                grid.innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <div class="mono text-xl text-red-400 mb-4">Error loading collection</div>
                        <div class="mono text-caption text-muted/70">${error.message}</div>
                    </div>
                `;
            }
        }

        function createCard(deck, hasPass) {
            const el = document.createElement('div');
            el.className = 'glass rounded-3xl p-8 hover-lift fade-in relative';

            // In vault, all cards are owned - show balance if > 1
            const statusBadge = deck.balance > 1
                ? `<div class="badge border-accent/20 bg-accent/5 text-accent/90">Owned × ${deck.balance}</div>`
                : `<div class="badge border-accent/20 bg-accent/5 text-accent/90">Owned</div>`;

            // Always show "Access Deck" button in vault
            const action = `<button onclick="openDeck(${deck.contentId})" class="btn text-text px-6 py-3.5 rounded-xl text-sm w-full"><span class="relative z-10">Access Deck</span></button>`;

            el.innerHTML = `
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>

                <div class="relative z-10">
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-6">
                        <div class="flex-1">
                            <h3 class="heading text-2xl text-text mb-1.5">${deck.name}</h3>
                            <div class="flex items-center gap-2 text-muted text-caption">
                                <span>${deck.year}</span>
                                <span class="opacity-30">•</span>
                                <span>${deck.creator}</span>
                            </div>
                        </div>
                        <div class="mono text-micro text-muted/50 mt-1">ID:${deck.contentId}</div>
                    </div>

                    ${deck.legacy ? `<div class="badge border-amber-400/20 bg-amber-400/5 text-amber-400/90 mb-4">Legacy</div>` : ''}

                    <!-- Description -->
                    <p class="text-muted text-sm leading-relaxed mb-6">${deck.description}</p>

                    <!-- Status -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        ${statusBadge}
                        <div class="badge border-border bg-surface/50 text-muted/70">${deck.tradition}</div>
                    </div>

                    <!-- Metrics -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <div class="text-center glass rounded-xl py-3">
                            <div class="mono text-micro text-muted/70 mb-1">Supply</div>
                            <div class="mono text-sm text-accent/90">${deck.maxSupply === 0 ? '∞' : deck.maxSupply}</div>
                        </div>
                        <div class="text-center glass rounded-xl py-3">
                            <div class="mono text-micro text-muted/70 mb-1">Minted</div>
                            <div class="mono text-sm text-accent/90">${deck.totalMinted || '0'}</div>
                        </div>
                        <div class="text-center glass rounded-xl py-3">
                            <div class="mono text-micro text-muted/70 mb-1">Cards</div>
                            <div class="mono text-sm text-accent/90">78</div>
                        </div>
                    </div>

                    <!-- Action -->
                    ${action}
                </div>
            `;

            return el;
        }

        function openDeck(id) {
            window.location.href = `reader.html?contentId=${id}`;
        }

        // Auto-connect if wallet was previously connected
        window.addEventListener('load', async () => {
            if (walletManager.isConnected()) {
                await connectWallet();
            }
        });
    </script>

    <script src="nav-component.js"></script>
</body>
</html>
