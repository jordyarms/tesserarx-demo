<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deck Library ‚Äî Tesserarx</title>
    <meta name="description" content="Browse and claim tarot deck passes on Moonbase Alpha. Free and paid content powered by blockchain.">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: '#08090e',
                        surface: '#0f1117',
                        border: '#181b24',
                        accent: '#00c9ff',
                        accent2: '#8b7aff',
                        muted: '#9ca3af'
                    }
                }
            }
        }
    </script>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="dist/tesserarx-polkadot.iife.js"></script>
    <script src="content-loader.js"></script>
</head>
<body>
    <div class="grid-overlay"></div>

    <div class="relative z-10">
        <div class="max-w-7xl mx-auto px-6 md:px-12 py-16 md:py-24">

            <!-- Header -->
            <header class="mb-24 fade-in" style="animation-delay: 0s">
                <div class="text-center">
                    <!-- Logo -->
                    <h1 class="heading text-5xl mb-4">
                       Marketplace
                    </h1>
                    <!-- Decorative line -->
                    <div class="divider mt-12"></div>
                </div>
            </header>

            <!-- Connection -->
            <div class="glass rounded-3xl p-10 mb-12 hover-lift fade-in relative" style="animation-delay: 0.1s">
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>

                <div class="text-center relative z-10">
                    <button
                        id="connectButton"
                        onclick="connectWallet()"
                        class="btn text-text px-12 py-4 rounded-xl relative"
                    >
                        <span class="relative z-10">Initialize Connection</span>
                    </button>
                    <div id="walletInfo" class="mt-6 hidden"></div>
                </div>
            </div>

            <!-- Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-16 fade-in" style="animation-delay: 0.2s">
                <div class="glass rounded-2xl p-6 hover-lift text-center">
                    <div class="mono text-micro text-muted uppercase mb-3">Total Decks</div>
                    <div class="mono text-4xl text-accent font-light" id="totalDecks">‚Äî</div>
                </div>
                <div class="glass rounded-2xl p-6 hover-lift text-center">
                    <div class="mono text-micro text-muted uppercase mb-3">Owned</div>
                    <div class="mono text-4xl text-accent2 font-light" id="ownedDecks">‚Äî</div>
                </div>
                <div class="glass rounded-2xl p-6 hover-lift text-center">
                    <div class="mono text-micro text-muted uppercase mb-3">Free Access</div>
                    <div class="mono text-4xl text-green-400 font-light" id="freeDecks">‚Äî</div>
                </div>
                <div class="glass rounded-2xl p-6 hover-lift text-center">
                    <div class="mono text-micro text-muted uppercase mb-3">Network</div>
                    <div class="mono text-2xl text-text/80 font-light">Moonbase</div>
                </div>
            </div>

            <!-- Deck Grid -->
            <div id="deckGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-20">
                    <div class="status mx-auto mb-4"></div>
                    <div class="mono text-caption text-muted">Loading vault data...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="glass rounded-2xl p-8 max-w-md w-full">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-light text-accent">Purchase Pass</h3>
                <button onclick="closePurchaseModal()" class="text-muted hover:text-text text-2xl transition-colors">&times;</button>
            </div>

            <!-- Content Info -->
            <div class="mb-6">
                <h4 id="modal-deck-name" class="text-lg text-text font-medium mb-1"></h4>
                <p id="modal-deck-creator" class="text-sm text-muted"></p>
            </div>

            <!-- Payment Breakdown -->
            <div class="bg-surface/50 rounded-xl p-4 mb-6 space-y-2 text-sm font-mono">
                <div class="flex justify-between">
                    <span class="text-muted">Content Price:</span>
                    <span id="breakdown-price" class="text-text font-medium">-</span>
                </div>
                <div class="flex justify-between text-xs text-muted/70">
                    <span>Platform Fee (1%):</span>
                    <span id="breakdown-platform">-</span>
                </div>
                <div class="flex justify-between text-xs text-muted/70">
                    <span id="breakdown-referral-label">Referral (0%):</span>
                    <span id="breakdown-referral">-</span>
                </div>
                <div class="border-t border-border pt-2 flex justify-between">
                    <span class="text-muted">Creator Receives:</span>
                    <span id="breakdown-creator" class="text-accent2 font-medium">-</span>
                </div>
            </div>

            <!-- Referral Input -->
            <div class="mb-6">
                <label class="text-sm text-muted mb-2 block font-mono uppercase text-micro">Referral Code (Optional)</label>
                <input
                    type="text"
                    id="referral-input"
                    placeholder="0x..."
                    class="w-full bg-surface/50 text-text border border-border/50 px-4 py-3 rounded-lg focus:outline-none focus:border-accent/50 transition-colors font-mono text-sm"
                >
                <p id="referral-status" class="text-xs mt-2"></p>
            </div>

            <!-- Actions -->
            <div class="flex gap-3">
                <button
                    onclick="closePurchaseModal()"
                    class="flex-1 bg-surface/50 text-text font-medium px-6 py-3 rounded-lg hover:bg-surface transition-all"
                >
                    Cancel
                </button>
                <button
                    id="confirm-purchase-btn"
                    onclick="executePurchase()"
                    class="flex-1 bg-gradient-to-r from-accent2 to-accent text-text font-medium px-6 py-3 rounded-lg hover:opacity-90 transition-all"
                >
                    Purchase
                </button>
            </div>
        </div>
    </div>

    <script>
        // Contract ABI - V2.1 (CONTRACT_ADDRESS and MOONBASE_ALPHA come from wallet-persistence.js)
        const CONTRACT_ABI = [
            // ERC-1155 Standard
            "function balanceOf(address account, uint256 id) view returns (uint256)",
            "function uri(uint256 tokenId) view returns (string)",

            // V2.1 Content Info - Fixed to match actual contract
            "function getContentInfo(uint256 contentId) view returns (address creator, string name, uint256 maxSupply, uint256 totalMinted, uint256 activeVersionIndex, uint256 price)",
            "function getActiveVersion(uint256 contentId) view returns (tuple(string payloadURI, string specificationURI, string manifestURI, uint256 timestamp, string reason, address updatedBy))",
            "function contentCreators(uint256 contentId) view returns (address)",

            // V2.1 Purchase Functions
            "function purchase(uint256 contentId, uint256 amount) external payable",
            "function purchaseWithReferral(uint256 contentId, uint256 amount, address referrer) external payable",
            "function claim(uint256 contentId) external",

            // V2.1 Pricing
            "function contentPrice(uint256 contentId) view returns (uint256)",
            "function setPrice(uint256 contentId, uint256 newPrice) external",

            // V2.1 Referral System
            "function referralRate(uint256 contentId) view returns (uint256)",
            "function setReferralRate(uint256 contentId, uint256 newRate) external",
            "function referralEarnings(address account) view returns (uint256)",
            "function withdrawReferralEarnings() external",

            // V2.1 Platform Fee
            "function platformFeeRate() view returns (uint256)",
            "function treasury() view returns (address)",

            // V2.1 Withdrawals
            "function pendingWithdrawals(address account) view returns (uint256)",
            "function withdraw() external"
        ];

        // DECKS array now loaded dynamically from contract + manifest URIs
        // See content-loader.js for implementation

        let provider, contract, userAddress;

        async function connectWallet() {
            try {
                console.log('üîÑ Starting wallet connection...');

                // Use Polkadot wallet manager
                const connected = await walletManager.connect();
                console.log('‚úì Wallet manager connected:', connected);

                if (!connected) {
                    return;
                }

                // Get provider and contract from wallet manager
                console.log('üîÑ Getting Web3 provider...');
                provider = await walletManager.getWeb3Provider();
                console.log('‚úì Provider obtained');

                console.log('üîÑ Getting contract instance...');
                contract = await walletManager.getContract(CONTRACT_ABI);
                console.log('‚úì Contract obtained:', contract ? 'success' : 'failed');

                userAddress = walletManager.getEvmAddress();
                console.log('‚úì User address:', userAddress);

                document.getElementById('connectButton').style.display = 'none';
                document.getElementById('walletInfo').classList.remove('hidden');

                const accountName = walletManager.getAccount()?.meta?.name || 'Account';
                document.getElementById('walletInfo').innerHTML = `
                    <div class="inline-flex items-center gap-2 mono text-caption text-accent">
                        <div class="status"></div>
                        <span>Connected: ${accountName} (${userAddress.slice(0, 6)}...${userAddress.slice(-4)})</span>
                    </div>
                `;

                console.log('üîÑ Loading marketplace library...');
                // Clear cache to ensure fresh data after connection
                ContentLoader.clearDeckCache(userAddress);
                await loadLibrary(true); // Force refresh
                console.log('‚úì Marketplace loaded successfully');

            } catch (error) {
                console.error('‚ùå Connection error:', error);
                alert('Connection failed: ' + error.message);
            }
        }

        async function loadLibrary(forceRefresh = false) {
            const grid = document.getElementById('deckGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-20"><div class="status mx-auto mb-4"></div><div class="mono text-caption text-muted">Loading decks from blockchain...</div></div>';

            try {
                // If force refresh (after purchase), get a fresh contract instance
                let contractToUse = contract;
                if (forceRefresh) {
                    contractToUse = await walletManager.getContract(CONTRACT_ABI);
                }

                // Load all decks dynamically from contract + manifests
                // Pass userAddress for wallet-specific caching
                const decks = await ContentLoader.loadAllDecks(contractToUse, true, userAddress);

                grid.innerHTML = '';
                let owned = 0, free = 0;

                for (const [index, deck] of decks.entries()) {
                    // Check ownership
                    const balance = await contractToUse.balanceOf(userAddress, deck.contentId);
                    const hasPass = balance.toNumber() > 0;
                    if (hasPass) owned++;
                    if (deck.free) free++;

                    // Create and append card
                    const card = createCard(deck, hasPass);
                    card.style.animationDelay = `${0.3 + index * 0.08}s`;
                    grid.appendChild(card);
                }

                // Update stats
                document.getElementById('totalDecks').textContent = decks.length;
                document.getElementById('ownedDecks').textContent = owned;
                document.getElementById('freeDecks').textContent = free;

                // Update global contract if we got a fresh one
                if (forceRefresh) {
                    contract = contractToUse;
                }

            } catch (error) {
                console.error('Failed to load library:', error);
                grid.innerHTML = '<div class="col-span-full text-center py-20"><div class="mono text-caption text-red-400">Failed to load decks. Please refresh.</div></div>';
            }
        }

        function createCard(deck, hasPass) {
            const el = document.createElement('div');
            el.className = 'glass rounded-3xl p-8 hover-lift fade-in relative';

            const statusBadge = hasPass
                ? `<div class="badge border-accent/20 bg-accent/5 text-accent/90">Owned</div>`
                : deck.free
                ? `<div class="badge border-green-400/20 bg-green-400/5 text-green-400/90">Free</div>`
                : `<div class="badge border-accent2/20 bg-accent2/5 text-accent2/90">${deck.price} DEV</div>`;

            const action = hasPass
                ? `<button onclick="openDeck(${deck.contentId})" class="btn text-text px-6 py-3.5 rounded-xl text-sm w-full"><span class="relative z-10">Access Deck</span></button>`
                : deck.free
                ? `<button onclick="claim(${deck.contentId})" class="btn text-text px-6 py-3.5 rounded-xl text-sm w-full"><span class="relative z-10">Claim Pass</span></button>`
                : `<button onclick="showPurchaseModal(${deck.contentId})" class="btn text-text px-6 py-3.5 rounded-xl text-sm w-full"><span class="relative z-10">Purchase Pass</span></button>`;

            el.innerHTML = `
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>

                <div class="relative z-10">
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-6">
                        <div class="flex-1">
                            <h3 class="heading text-2xl text-text mb-1.5">${deck.name}</h3>
                            <div class="flex items-center gap-2 text-muted text-caption">
                                <span>${deck.year}</span>
                                <span class="opacity-30">‚Ä¢</span>
                                <span>${deck.creator}</span>
                            </div>
                        </div>
                        <div class="mono text-micro text-muted/50 mt-1">ID:${deck.contentId}</div>
                    </div>

                    ${deck.legacy ? `<div class="badge border-amber-400/20 bg-amber-400/5 text-amber-400/90 mb-4">Legacy</div>` : ''}

                    <!-- Description -->
                    <p class="text-muted text-sm leading-relaxed mb-6">${deck.description}</p>

                    <!-- Status -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        ${statusBadge}
                        <div class="badge border-border bg-surface/50 text-muted/70">${deck.tradition}</div>
                    </div>

                    <!-- Metrics -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <div class="text-center glass rounded-xl py-3">
                            <div class="mono text-micro text-muted/70 mb-1">Supply</div>
                            <div class="mono text-sm text-accent/90">${deck.maxSupply === 0 ? '‚àû' : deck.maxSupply}</div>
                        </div>
                        <div class="text-center glass rounded-xl py-3">
                            <div class="mono text-micro text-muted/70 mb-1">Minted</div>
                            <div class="mono text-sm text-accent/90">${deck.totalMinted || '0'}</div>
                        </div>
                        <div class="text-center glass rounded-xl py-3">
                            <div class="mono text-micro text-muted/70 mb-1">Cards</div>
                            <div class="mono text-sm text-accent/90">78</div>
                        </div>
                    </div>

                    <!-- Action -->
                    ${action}
                </div>
            `;

            return el;
        }

        async function claim(id) {
            try {
                if (confirm('Claim this free deck pass?')) {
                    const tx = await contract.claim(id);
                    alert('Claiming pass...');
                    await tx.wait();
                    alert('Pass claimed successfully!');
                    await loadLibrary(true); // Force refresh after claim
                }
            } catch (error) {
                console.error('Claim error:', error);
                if (error.message.includes('Already claimed')) {
                    alert('You have already claimed this deck.');
                } else if (error.message.includes('Content is not free')) {
                    alert('This deck is not free. Please use the purchase option.');
                } else {
                    alert('Claim failed: ' + error.message);
                }
            }
        }

        async function purchase(id, price) {
            try {
                const value = parseFloat(price.split(' ')[0]);
                const wei = ethers.utils.parseEther(value.toString());
                const creator = await contract.contentCreators(id);

                if (confirm(`Purchase pass for ${price}?`)) {
                    const tx = await signer.sendTransaction({ to: creator, value: wei });
                    alert('Processing payment...');
                    await tx.wait();
                    alert('Payment confirmed.\n\nCreator will mint your pass.');
                    await loadLibrary();
                }
            } catch (error) {
                alert('Transaction failed: ' + error.message);
            }
        }

        function openDeck(id) {
            window.location.href = `reader.html?contentId=${id}`;
        }

        // V2.1 Purchase Modal Functions
        let currentPurchaseContent = null;

        async function showPurchaseModal(contentId) {
            currentPurchaseContent = contentId;

            try {
                // Get content info
                const info = await contract.getContentInfo(contentId);
                const price = await contract.contentPrice(contentId);
                const platformFeeRate = await contract.platformFeeRate();
                const referralRate = await contract.referralRate(contentId);

                // Update modal
                document.getElementById('modal-deck-name').textContent = info.name;
                document.getElementById('modal-deck-creator').textContent = `by ${shortenAddress(info.creator)}`;

                // Calculate breakdown
                const platformFee = price.mul(platformFeeRate).div(10000);
                const remaining = price.sub(platformFee);
                const referralFee = remaining.mul(referralRate).div(10000);
                const creatorAmount = remaining.sub(referralFee);

                // Display
                document.getElementById('breakdown-price').textContent = `${ethers.utils.formatEther(price)} DEV`;
                document.getElementById('breakdown-platform').textContent = `${ethers.utils.formatEther(platformFee)} DEV`;
                document.getElementById('breakdown-referral-label').textContent = `Referral (${referralRate / 100}%):`;
                document.getElementById('breakdown-referral').textContent = referralRate > 0 ? `${ethers.utils.formatEther(referralFee)} DEV` : 'N/A';
                document.getElementById('breakdown-creator').textContent = `${ethers.utils.formatEther(creatorAmount)} DEV`;

                // Check URL for referral
                const urlParams = new URLSearchParams(window.location.search);
                const refParam = urlParams.get('ref');
                if (refParam && ethers.utils.isAddress(refParam)) {
                    document.getElementById('referral-input').value = refParam;
                    document.getElementById('referral-status').textContent = `‚úì Using referral: ${shortenAddress(refParam)}`;
                    document.getElementById('referral-status').className = 'text-xs mt-2 text-accent';
                }

                // Show modal
                document.getElementById('purchaseModal').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading purchase modal:', error);
                alert('Failed to load purchase information');
            }
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').classList.add('hidden');
            currentPurchaseContent = null;
        }

        async function executePurchase() {
            if (!currentPurchaseContent || !userAddress) return;

            const contentId = currentPurchaseContent;
            const referrerInput = document.getElementById('referral-input').value.trim();
            const referrer = (referrerInput && ethers.utils.isAddress(referrerInput))
                ? referrerInput
                : ethers.constants.AddressZero;

            try {
                const btn = document.getElementById('confirm-purchase-btn');
                btn.disabled = true;
                btn.textContent = 'Processing...';

                // Get price
                const price = await contract.contentPrice(contentId);

                // Execute purchase
                const tx = (referrer !== ethers.constants.AddressZero)
                    ? await contract.purchaseWithReferral(contentId, 1, referrer, { value: price })
                    : await contract.purchase(contentId, 1, { value: price });

                btn.textContent = 'Confirming...';

                // Wait for confirmation
                await tx.wait();

                // Success - clear cache to ensure fresh data everywhere
                ContentLoader.clearDeckCache();
                alert('‚úÖ Pass purchased successfully!');

                await loadLibrary(true); // Force refresh after purchase

                // Reset and close modal
                btn.disabled = false;
                btn.textContent = 'Purchase';
                closePurchaseModal();

            } catch (error) {
                console.error('Purchase failed:', error);
                alert(`‚ùå Purchase failed: ${error.message || 'Unknown error'}`);

                const btn = document.getElementById('confirm-purchase-btn');
                btn.disabled = false;
                btn.textContent = 'Purchase';
            }
        }

        async function claimFreePass(contentId) {
            if (!userAddress) {
                alert('Please connect wallet first');
                return;
            }

            try {
                const tx = await contract.claim(contentId);
                alert('‚è≥ Claiming free pass...');
                await tx.wait();

                // Clear cache to ensure fresh data everywhere
                ContentLoader.clearDeckCache();
                alert('‚úÖ Free pass claimed!');
                await loadLibrary(true); // Force refresh after claim
            } catch (error) {
                console.error('Claim failed:', error);
                alert(`‚ùå Claim failed: ${error.message}`);
            }
        }

        function shortenAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // Auto-connect if wallet was previously connected
        window.addEventListener('load', async () => {
            if (walletManager.isConnected()) {
                await connectWallet();
            }
        });
    </script>

    <script src="nav-component.js"></script>
</body>
</html>
